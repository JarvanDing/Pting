{% extends 'base.html' %}

{% block title %}测试结果 - {{ server.hostname }}{% endblock %}

{% block content %}
    <section class="section">
        <div class="container">
            <h1 class="title">{{ server.hostname }} 的测试结果</h1>
            <p class="subtitle">描述: {{ server.description }}</p>

            <div class="content">
                <h2>Ping 测试结果</h2>
                {% if ping_results %}
                    <table class="table is-striped is-narrow is-fullwidth">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>发送</th>
                                <th>接收</th>
                                <th>丢包率</th>
                                <th>最小 RTT</th>
                                <th>平均 RTT</th>
                                <th>最大 RTT</th>
                                <th>原始结果</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for result_data in ping_results %}
                            <tr>
                                <td>{{ result_data.raw.test_time }}</td>
                                <td>{{ result_data.parsed.packets_transmitted }}</td>
                                <td>{{ result_data.parsed.packets_received }}</td>
                                <td>{{ result_data.parsed.packet_loss }}</td>
                                <td>{{ result_data.parsed.min_rtt }}</td>
                                <td>{{ result_data.parsed.avg_rtt }}</td>
                                <td>{{ result_data.parsed.max_rtt }}</td>
                                <td><pre>{{ result_data.raw.result_output }}</pre></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>暂无 Ping 测试结果。</p>
                {% endif %}

                <h2 class="mt-4">Traceroute 测试结果</h2>
                {% if traceroute_results %}
                    {% for result_data in traceroute_results %}
                        <h3>测试时间: {{ result_data.raw.test_time }}</h3>
                        
                        {% if result_data.processed_hops_with_location %}
                            {# Use the new structured data with location or private IP identifier #}
                            <table class="table is-striped is-narrow is-fullwidth">
                                <thead>
                                    <tr>
                                        <th>跳数</th>
                                        <th>主机/IP</th>
                                        <th>地理位置 (国家/城市)</th>
                                        <th>延迟</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for hop in result_data.processed_hops_with_location %}
                                    <tr>
                                        <td>{{ hop.hop_number }}</td>
                                        <td>
                                            {% for detail in hop.details %}
                                                {{ detail.host }}{% if detail.ip and detail.ip != 'N/A' %} ({{ detail.ip }}){% endif %}<br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for detail in hop.details %}
                                                {% if detail.location %}
                                                    {{ detail.location.country }}{% if detail.location.city %}, {{ detail.location.city }}{% endif %}
                                                {% elif detail.display_location %}
                                                    {{ detail.display_location }}
                                                {% else %}
                                                    N/A
                                                {% endif %}<br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for detail in hop.details %}
                                                {{ detail.rtt }}<br>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% elif result_data.fallback_processed_hops %}
                             {# Fallback to showing original parsed data with private IP identifier if new structured data is not available #}
                            <table class="table is-striped is-narrow is-fullwidth">
                                <thead>
                                    <tr>
                                        <th>跳数</th>
                                        <th>主机/IP</th>
                                        <th>地理位置 (局域网/本地)</th> {# Update header for clarity #}
                                        <th>延迟</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for hop in result_data.fallback_processed_hops %}
                                    <tr>
                                        <td>{{ hop.hop_number }}</td>
                                        <td>
                                            {% for detail in hop.details %}
                                                {{ detail.host }}{% if detail.ip and detail.ip != 'N/A' %} ({{ detail.ip }}){% endif %}<br>
                                            {% endfor %}
                                        </td>
                                         <td>
                                            {% for detail in hop.details %}
                                                {% if detail.display_location %}
                                                     {{ detail.display_location }}
                                                {% else %}
                                                     N/A
                                                {% endif %}<br>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% elif result_data.parsed %}
                            {# Fallback to showing original parsed data if neither processed data nor fallback processed data is available #}
                            <table class="table is-striped is-narrow is-fullwidth">
                                <thead>
                                    <tr>
                                        <th>跳数</th>
                                        <th>主机/IP</th>
                                        <th>延迟</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for hop in result_data.parsed %}
                                    <tr>
                                        <td>{{ hop.hop_number }}</td>
                                        <td>
                                            {% for detail in hop.details %}
                                                {{ detail.host }} ({{ detail.ip }})<br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for detail in hop.details %}
                                                {{ detail.rtt }}<br>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>无法解析 Traceroute 结果或结果为空。</p>
                        {% endif %}
                        
                        <h4>原始结果:</h4>
                        <pre>{{ result_data.raw.result_output }}</pre>
                        <hr>
                    {% endfor %}
                {% else %}
                    <p>暂无 Traceroute 测试结果。</p>
                {% endif %}
            </div>

            <p class="mt-4"><a href="{{ url_for('index') }}">返回列表</a></p>
        </div>
    </section>
{% endblock %} 